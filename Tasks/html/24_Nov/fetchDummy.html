<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch Data</title>
    <link rel="stylesheet" href="/dist/output.css">
</head>

<body>
    <div class="flex justify-center mt-5 gap-5">
        <div class="flex justify-center">
            <div class="relative inline-block text-left">
                <div>
                    <button id="filterButton"
                        class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring focus:border-blue-300">
                        Filter Categories
                        <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                            fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd"
                                d="M5.293 7.293a1 1 0 0 1 1.414 0L10 11.586l3.293-3.293a1 1 0 1 1 1.414 1.414l-4 4a1 1 0 0 1-1.414 0l-4-4a1 1 0 0 1 0-1.414z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <div id="filterDropdown"
                    class="hidden origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5">
                    <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                        <button type="button" name="smartphones"
                            class="w-full text-start px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900"
                            role="menuitem">Smartphones</button>
                        <button type="button" name="laptops"
                            class="w-full text-start px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900"
                            role="menuitem">Laptops</a>
                            <button type="button" name="fragrances"
                                class="w-full text-start px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900"
                                role="menuitem">Fragrances</button>
                            <button type="button" name="skincare"
                                class="w-full text-start px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900"
                                role="menuitem">Skincare</button>
                            <button type="button" name="groceries"
                                class="w-full text-start px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900"
                                role="menuitem">Groceries</button>
                            <button type="button" name="home-decoration"
                                class="w-full text-start px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900"
                                role="menuitem">Home-Decoration</button>
                    </div>
                </div>
            </div>
        </div>
        <input type="search" id="js_search" class="border-2 h-10 w-72 rounded-lg p-2 outline-0"
            placeholder="Search Product">
        <button type="button" class="bg-blue-500 font-semibold text-white p-2 rounded-lg" id="js_button">Add New
            Product</button>
    </div>



    <dialog id="js_dialog" class="bg-white p-4 rounded-lg shadow-lg w-2/6">
        <form action="#" id="js_form" class="w-full">
            <label for="js_title" class="block text-sm font-medium text-gray-700">Title</label>
            <input type="text" id="js_title" class="mt-1 p-2 block w-full rounded-md border-2 border-gray-300"
                name="title">

            <label for="js_description" class="block mt-4 text-sm font-medium text-gray-700">Description</label>
            <input type="text" id="js_description" class="mt-1 p-2 block w-full rounded-md border-2 border-gray-300"
                name="description">

            <label for="js_category" class="block mt-4 text-sm font-medium text-gray-700">Category</label>
            <input type="text" id="js_category" class="mt-1 p-2 block w-full rounded-md border-2 border-gray-300"
                name="category">

            <label for="js_brand" class="block mt-4 text-sm font-medium text-gray-700">Brand</label>
            <input type="text" id="js_brand" class="mt-1 p-2 block w-full rounded-md border-2 border-gray-300"
                name="brand">

            <label for="js_discount" class="block mt-4 text-sm font-medium text-gray-700">Discount Percentage</label>
            <input type="text" id="js_discount" class="mt-1 p-2 block w-full rounded-md border-2 border-gray-300"
                name="discountPercentage">

            <label for="js_stock" class="block mt-4 text-sm font-medium text-gray-700">Stock</label>
            <input type="number" id="js_stock" class="mt-1 p-2 block w-full rounded-md border-2 border-gray-300"
                name="stock">

            <label for="js_price" class="block mt-4 text-sm font-medium text-gray-700">Price</label>
            <input type="number" id="js_price" class="mt-1 p-2 block w-full rounded-md border-2 border-gray-300"
                name="price">

            <label for="js_rating" class="block mt-4 text-sm font-medium text-gray-700">Rating</label>
            <input type="text" id="js_rating" class="mt-1 p-2 block w-full rounded-md border-2 border-gray-300"
                name="rating">

            <label for="js_thumbnail" class="block mt-4 text-sm font-medium text-gray-700">Thumbnail</label>
            <input type="file" id="js_thumbnail" class="mt-1 p-2 block w-full rounded-md border-2 border-gray-300"
                name="thumbnail">

            <div class="w-full p-2 bg-white border-2 border-gray-300 mt-4 rounded-lg">
                <label for="js_imageCount" class="block text-sm font-medium text-gray-700 mb-2">Select Image
                    Quantity</label>
                <select id="js_imageCount" class="w-full border-2 rounded-md p-2" name="images">
                    <option value="1" name="image_1">1</option>
                    <option value="2" name="image_2">2</option>
                    <option value="3" name="image_3">3</option>
                    <option value="4" name="image_4">4</option>
                    <option value="5" name="image_5">5</option>
                </select>
                <div id="js_imageFieldsContainer" class="space-y-4"></div>
            </div>

            <div class="flex justify-between">
                <button type="button" id="js_closeButton"
                    class="bg-red-500 p-2 w-36 h-10 mt-6 text-white rounded-md hover:bg-red-600 focus:outline-none focus:ring focus:border-blue-300"
                    id="js_close">Close</button>
                <button type="submit" id="js_addCustomButton"
                    class="bg-blue-500 p-2 w-36 h-10 mt-6 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring focus:border-blue-300"
                    id="js_addCustom">Add</button>
            </div>
        </form>
    </dialog>

    <ul id="js_products" class="p-6 flex flex-wrap gap-8 space-y-12 justify-center items-center">
    </ul>

    <script>
        (function () {
            'use strict'
            const products = {
                //api url
                apiUrl: 'https://dummyjson.com/products/',

                //fetch the data 
                fetchData: async function () {
                    try {
                        const response = await fetch(this.apiUrl);
                        if (response.ok) {
                            const data = await response.json();
                            const getData = this.getFromStorage().products
                            if (!getData) {
                                products.saveToLocalStorage(data);
                            }
                            return data;
                        }
                        else {
                            throw new Error('Error');
                        }
                    }
                    catch (error) {
                        console.error('Error fetching data:', error);
                        return null;
                    }
                },

                //post new data
                postData: async function (productData) {
                    const postUrl = 'https://dummyjson.com/products/add';
                    try {

                        const options = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json;charset=utf-8'
                            },
                            body: JSON.stringify(productData)
                        }

                        let response = await fetch(postUrl, options)
                        if (!response.ok) {
                            console.log("HTTP Error: " + response.status)
                            return {
                                data: null,
                                error: "Something went wrong. Try Again!"
                            }
                        }

                        const newProduct = await response.json();
                        const localStorageData = this.getFromStorage();
                        localStorageData.products.push(newProduct);
                        this.saveToLocalStorage(localStorageData);
                        return localStorageData.products;
                    }
                    catch (error) {
                        console.error("HTTP Error " + response.status)
                    }
                },

                //form data 
                saveDataFromForm: function () {
                    const form = document.getElementById('js_form');
                    form.addEventListener("submit", async function (event) {
                        event.preventDefault();
                        const formData = new FormData(form);

                        const imageCount = formData.get('imageCount');
                        const imageFiles = [];

                        const readImage = async function (imageInput) {
                            return new Promise((resolve) => {
                                const imageReader = new FileReader();
                                imageReader.readAsDataURL(imageInput);

                                imageReader.onload = function () {
                                    resolve(imageReader.result);
                                };
                            });
                        };

                        const thumbnailInput = formData.get('thumbnail');
                        const thumbnailData = await readImage(thumbnailInput);

                        for (let i = 1; i <= imageCount; i++) {
                            const imageInput = formData.get(`image_${i}`);
                            const imageData = await readImage(imageInput);
                            imageFiles.push(imageData);
                        }

                        const newProduct = {
                            title: formData.get('title'),
                            description: formData.get('description'),
                            category: formData.get('category'),
                            brand: formData.get('brand'),
                            discountPercentage: formData.get('discountPercentage'),
                            stock: formData.get('stock'),
                            price: formData.get('price'),
                            rating: formData.get('rating'),
                            thumbnail: thumbnailData,
                            images: imageFiles,
                        };

                        products.postData(newProduct);
                    });
                },

                //render data
                render: function (productObjects) {
                    console.log(productObjects);
                    const productsContainer = document.getElementById('js_products');
                    let products = ``;
                    productObjects.forEach((element) => {
                        products += `<li
                        data-product-id="${element.id}" 
                        class=" w-80 hover:shadow-md hover:shadow-gray-400 rounded-lg flex justify-center items-center flex-col cursor-pointer pt-4" >
                         <!-- image -->
                        <div class=" w-44">
                            <img class="h-24 object-cover" src=${element.thumbnail}
                                alt="Product Image">
                        </div>

                        <!--description -->
                        <div class="p-4 space-y-2">
                            <h2 class="line-clamp-2">${element.title}</h2>
                            <!-- rating -->
                            <div class="flex gap-2">
                                <div class="bg-green-700 text-white pl-2 py-0.5 rounded-sm text-sm relative w-12 ">${element.rating}
                            </div>

                            <!-- price -->
                            <div class="flex space-x-2 items-center"><span class="font-semibold">&#8377;${element.price}</span>
                            </div>
                        </div>
                        </li>`;

                    })
                    productsContainer.innerHTML = products;
                },

                //click on products
                productsPage: function () {
                    const productsContainer = document.getElementById('js_products');
                    productsContainer.addEventListener('click', function (event) {
                        const clickedProduct = event.target.closest('li[data-product-id]');
                        if (clickedProduct) {
                            const productId = clickedProduct.getAttribute('data-product-id');
                            window.location.href = `productsDummy.html?id=${productId}`;
                        }
                    });
                },

                //search products
                search: async function (searchValue) {
                    const searchURL = `https://dummyjson.com/products/search?q=${searchValue}`
                    try {
                        const responseSearch = await fetch(searchURL);
                        if (responseSearch.ok) {
                            const data = await responseSearch.json();
                            return data.products;
                        }
                    }
                    catch (error) {
                        console.error('Error fetching data:', error);
                        return null;
                    }
                },

                //event
                searchEvent: function () {
                    const searchInput = document.getElementById('js_search');
                    let debounceTimer;

                    searchInput.addEventListener("input", async function () {
                        const searchData = await products.search(searchInput.value)
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(async function () {
                            if (searchData !== null) {
                                products.render(searchData);
                            }
                        }, 300)
                    })
                },

                //open and close dialog box button
                openFromDialog: function () {
                    const addCustomButton = document.getElementById('js_button');
                    const close = document.getElementById('js_closeButton');
                    const dialog = document.getElementById('js_dialog');

                    addCustomButton.addEventListener("click", function () {
                        dialog.showModal();
                    })

                    close.addEventListener("click", function () {
                        dialog.close();
                    })
                },

                //generate multiple image fields
                generateImageFields: function (count) {
                    const container = document.getElementById('js_imageFieldsContainer');
                    container.innerHTML = '';

                    for (let i = 1; i <= count; i++) {
                        const label = document.createElement('label');
                        label.setAttribute('for', `js_image${i}`);
                        label.className = 'block mt-4 text-sm font-medium text-gray-700';
                        label.textContent = `Image ${i}`;

                        const input = document.createElement('input');
                        input.setAttribute('type', 'file');
                        input.id = `js_image${i}`;
                        input.className = 'mt-1 p-2 block w-full rounded-md border-2 border-gray-300';
                        input.name = `image_${i}`;

                        container.append(label, input);
                    }
                },

                // Function to handle dropdown change event
                handleImageCountChange: function () {
                    const dropdown = document.getElementById('js_imageCount');
                    const selectedCount = parseInt(dropdown.value, 10);
                    this.generateImageFields(selectedCount);
                },

                // add event for dropdown
                dropDownEvent: function () {
                    const dropdown = document.getElementById('js_imageCount');
                    dropdown.addEventListener('change', () => products.handleImageCountChange());
                },

                //filter dropdown
                filterDropDown: function () {
                    const filterButton = document.getElementById('filterButton');
                    const filterDropdown = document.getElementById('filterDropdown');

                    filterButton.addEventListener('click', (event) => {
                        filterDropdown.classList.toggle('hidden');
                    });

                    document.addEventListener('click', (event) => {
                        const target = event.target;
                        if (!filterButton.contains(target) && !filterDropdown.contains(target)) {
                            filterDropdown.classList.add('hidden');
                        }
                    });
                },

                //fetch filter api
                fetchFilter: async function (filterValue) {
                    const searchURL = `https://dummyjson.com/products/category/${filterValue}`
                    try {
                        const responseSearch = await fetch(searchURL);
                        if (responseSearch.ok) {
                            const data = await responseSearch.json();
                            return data;
                        }
                    }
                    catch (error) {
                        console.error('Error fetching data:', error);
                        return null;
                    }
                },

                //filter 
                filterProducts: function () {
                    const filterItems = document.querySelectorAll('#filterDropdown button');

                    filterItems.forEach(item => {
                        item.addEventListener('click', async (event) => {
                            const selectedFilterValue = event.target.textContent.trim();
                            const filteredProducts = await products.fetchFilter(selectedFilterValue)
                            console.log(filteredProducts)
                            products.render(filteredProducts.products)
                            filterDropdown.classList.add('hidden');
                        });
                    });
                },

                //set items
                saveToLocalStorage: function (data) {
                    const existingData = localStorage.setItem('dummyProducts', JSON.stringify(data));
                    return existingData;
                },

                //get items
                getFromStorage: function () {
                    const getData = JSON.parse(localStorage.getItem('dummyProducts')) || [];
                    return getData;
                },

                //init
                init: async function () {
                    const awaitedPromise = await this.fetchData()
                    const jsonPromise = awaitedPromise.products
                    this.saveDataFromForm()
                    this.render(this.getFromStorage().products)
                    this.searchEvent()
                    this.productsPage()
                    this.openFromDialog()
                    this.dropDownEvent()
                    this.filterDropDown()
                    this.filterProducts()
                }

            }
            products.init()
        })()
    </script>
</body>

</html>